# Vidar Stealer 2.0 - YARA Rules

## 2025-11-03: Vidar Stealer 2.0
**Author:** Rhys Downing

**References:**
- https://www.ontinue.com/resources/?resource_type[]=blog

---

## YARA Rules

### MAL_Vidar_Stealer_Azure_MSAL_Targeting

Detects Vidar stealer targeting Azure Identity Service MSAL cache tokens for credential theft.

**MITRE ATT&CK Mappings:**
- T1528 - Steal Application Access Token
- T1555.005 - Credentials from Password Stores: Cloud Secrets

**Detection Logic:**
- Targets Azure Identity Service directory paths (`\AppData\Local\Packages\.Microsoft.AAD.BrokerPlugin_`)
- Searches for `msal.cache` files
- Identifies file operation APIs (CreateFile, ReadFile, GetFileSize)
- Detects HTTP exfiltration patterns (multipart form-data)

**File:** `MAL_Vidar_Stealer_Azure_MSAL_Targeting.yara`

```yara
rule MAL_Vidar_Stealer_Azure_MSAL_Targeting {
    meta:
        description = "Detects Vidar stealer targeting Azure Identity Service MSAL cache tokens for credential theft"
        author = "Rhys Downing"
        date = "2025-01-03"
        modified = "2025-01-03"
        reference = ""
        malware_family = "Vidar"
        tags = "STEALER, CREDENTIALS, AZURE, CLOUD"
        mitre_attack_t1 = "T1528 - Steal Application Access Token"
        mitre_attack_t2 = "T1555.005 - Credentials from Password Stores: Cloud Secrets"
        
    strings:
        // Azure Identity Service directory path (unique identifier)
        $a1 = "\\AppData\\Local\\Packages\\.Microsoft.AAD.BrokerPlugin_" ascii wide
        $a2 = "\\IdentityService\\msal.cache" ascii wide nocase
        
        // Very specific Azure/MSAL strings
        $x1 = "Azure\\.IdentityService" ascii wide
        $x2 = "Microsoft.AAD.BrokerPlugin" ascii wide
        $x3 = "msal.cache" ascii wide
        $x4 = ".azure\\msal_token_cache.json" ascii wide
        
        // Vidar-specific Azure reader functionality
        $x5 = "Azure Reader" ascii wide
        
        // Environment variable lookups (common but meaningful in context)
        $s1 = "LOCALAPPDATA" ascii wide
        $s2 = "USERPROFILE" ascii wide
        
        // HTTP EXFILTRATION PATTERNS ($http*)
        $http1 = "multipart/form-data; boundary=" ascii
        $http2 = "Content-Disposition: form-data; name=\"token\"" ascii
        $http3 = "Content-Disposition: form-data; name=\"hwid\"" ascii
        
        // FILE OPERATION APIs
        $f1 = "GetFileAttributesA" ascii
        $f2 = "GetFileAttributesW" ascii
        $f3 = "CreateFileA" ascii
        $f4 = "CreateFileW" ascii
        $f5 = "ReadFile" ascii
        $f6 = "GetFileSize" ascii
        $f7 = "FindFirstFileA" ascii
        $f8 = "FindFirstFileW" ascii
        
        // NETWORK APIs
        $net1 = "HttpSendRequestA" ascii
        $net2 = "HttpOpenRequestA" ascii
        $net3 = "InternetConnectA" ascii
        $net4 = "InternetOpenA" ascii
        
    condition:
        // PERFORMANCE OPTIMIZATIONS
        uint16(0) == 0x5A4D and
        filesize < 5MB and
        
        // CORE DETECTION LOGIC
        (
            // Strong match: Specific Azure/MSAL targeting
            (
                1 of ($a*) or
                (2 of ($x*) and 1 of ($s*))
            )
            and
            // File operations (credential theft capability)
            3 of ($f*)
            and
            // Exfiltration capability
            (
                2 of ($http*) or
                2 of ($net*)
            )
        )
        or
        // Alternative: Multiple specific Azure indicators + exfiltration
        (
            3 of ($x*)
            and 4 of ($f*)
            and 1 of ($http*)
        )
}
```

---

### Vidar_Stealer_v2_HTTP_Exfil

Detects Vidar Stealer 2.0 HTTP exfiltration patterns.

**Detection Logic:**
- Identifies multipart/form-data HTTP exfiltration
- Detects specific form field names (token, profile, hwid, file)
- Searches for Windows API imports (CryptUnprotectData, HttpSendRequestA, InternetConnectA)

**File:** `Vidar_Stealer_v2_HTTP_Exfil.yara`

```yara
rule Vidar_Stealer_v2_HTTP_Exfil {
    meta:
        description = "Detects Vidar Stealer 2.0 HTTP exfiltration patterns"
        author = "Rhys Downing"
        date = "2025-10-31"
        reference = ""
        version = "1.0"
        
    strings:
        // HTTP multipart form-data header (high confidence anchor)
        $header = "multipart/form-data; boundary=" ascii
        
        // Core exfiltration form fields (confirmed in malware analysis)
        $form_token = "Content-Disposition: form-data; name=\"token\"" ascii
        $form_profile = "Content-Disposition: form-data; name=\"profile\"" ascii
        $form_hwid = "Content-Disposition: form-data; name=\"hwid\"" ascii
        $form_file = "Content-Disposition: form-data; name=\"file\"" ascii
        
        // Optional form fields (verify these exist in your Ghidra analysis)
        $form_build_id = "Content-Disposition: form-data; name=\"build_id\"" ascii
        $form_mode = "Content-Disposition: form-data; name=\"mode\"" ascii
        
        // High-confidence API imports
        $api_crypt = "CryptUnprotectData" ascii
        $api_http_send = "HttpSendRequestA" ascii
        $api_inet_connect = "InternetConnectA" ascii
        $api_snapshot = "CreateToolhelp32Snapshot" ascii
        
        // Optional API (may not be present in memory injection variants)
        $api_bcrypt = "BCryptDecrypt" ascii
        
    condition:
        // PE file header check (cheap operation, placed first)
        uint16(0) == 0x5A4D and
        
        // File size constraint (cheap operation)
        filesize < 3MB and
        
        // Core detection: multipart header is essential
        $header and
        
        // Require strong evidence of exfiltration mechanism
        (
            // Strong match: 3+ core form fields + 3+ core APIs
            (3 of ($form_token, $form_profile, $form_hwid, $form_file) and 
             3 of ($api_crypt, $api_http_send, $api_inet_connect, $api_snapshot))
            or
            // Alternative: includes optional fields you observed in binary
            (1 of ($form_build_id, $form_mode) and 
             2 of ($form_token, $form_profile, $form_hwid, $form_file) and
             3 of ($api_*))
        )
}
```

---